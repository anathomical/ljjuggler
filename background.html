<html>
	<script type="text/javascript" src="md5.js"></script>
	<script type="text/javascript">
	var ljjuggler_version = "2.0";
	
	function page_loaded()
	{
		if(localStorage["ljjuggler_version"] < ljjuggler_version)
		{
			version_update(localStorage["ljjuggler_version"]);
		}
		chrome.extension.onRequest.addListener(
			function(request, sender, sendResponse)
			{
				console.log("setting interval for animation");
				if(request.command == "logout")
				{
					console.log("Logging out...");
					chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, function(cookie)
						{
							logout_this_cookie(cookie);
							sendResponse({});
						})
				}
				else if(request.command == "login")
				{
					console.log("Logging in as... " + request.account.username);
					chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, function(cookie)
						{
							logout_this_cookie(cookie);
							loginas(request.account);
							sendResponse({});
						})
				}
			});
	}
	function getLJchallenge()
	{
		var conn = new XMLHttpRequest();
		var params = "mode=getchallenge";
		conn.open("POST","http://www.livejournal.com/interface/flat",false);
		conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
		conn.send(params);
		challenge = conn.responseText.split("\n")[3];
		return challenge;
	}
	function loginas(this_account)
	{
		console.log("Beginning the login dance...");
		conn = new XMLHttpRequest();
		var challenge = getLJchallenge();
		var response = md5(challenge + this_account.password);
		var params = "mode=sessiongenerate" +
					"&user=" + this_account.username +
					"&auth_method=challenge" +
					"&auth_challenge=" + challenge +
					"&auth_response=" + response;
		conn.open("POST", "http://www.livejournal.com/interface/flat",false);
		conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
		conn.send(params);

		console.log("Login negotiations completed.  Saving session data.");
		var ljsession = conn.responseText.split("\n")[1];
		var session_fields = ljsession.split(":");
		var now = new Date();
		chrome.cookies.set({"url":"http://livejournal.com/", "domain":"livejournal.com", "name":"ljsession", "value":ljsession, "expirationDate":(now.valueOf() + (1000*60*60*24*365))});
		chrome.cookies.set({"url":"http://livejournal.com/", "domain":"livejournal.com", "name":"ljloggedin", "value":session_fields[1] + ":" + session_fields[2], "expirationDate":(now.valueOf() + (1000*60*60*24*365))});
		chrome.cookies.set({"url":"http://livejournal.com/", "domain":"livejournal.com", "name":"ljmastersession", "value":ljsession, "expirationDate":(now.valueOf() + (1000*60*60*24*365))});
		this_account.uid = ljsession.split(":")[1];
		update_account(this_account);
	}
	function logout_this_cookie(cookie)
	{
		if(cookie)
		{
			console.log("Logout subroutine started...");
			var cookie_fields = cookie.value.split(":");
			var sessid = cookie_fields[2].substring(1);
			conn = new XMLHttpRequest()
			var params = "mode=sessionexpire" +
						"&auth_method=cookie" +
						"&expire_id_" + sessid + "=1";
			conn.open("POST", "http://www.livejournal.com/interface/flat",false);
			conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
			conn.setRequestHeader("X-LJ-Auth","cookie");
			console.log("Logging out with cookie: " + cookie.value);
			conn.send(params);
			console.log("Deleting cookie...");
			chrome.cookies.remove({"url":"http://www" + cookie.domain + cookie.path,"name":"ljsession"});
			chrome.cookies.remove({"url":"http://www" + cookie.domain + cookie.path,"name":"ljloggedin"});
			chrome.cookies.remove({"url":"http://www" + cookie.domain + cookie.path,"name":"ljmastersession"});
		}
		else console.log("No cookie found, no need to log out.");
	}
	function version_update(old_version)
	{
		alert("LJ Juggler has been updated to the latest version: " + ljjuggler_version + "\n\nCheck out the change log at: http://rushin-doll.net/lj-juggler/change-log.html");
		localStorage["ljjuggler_version"] = ljjuggler_version;
		if(old_version < "2.0")
		{
				// Resave passwords as MD5 hashes for a slight security bump.
			var old_account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			var new_account_list
			for(var account in old_account_list)
			{
				account.password = md5(account.password);
				new_account_list.push(account);
			}
			localStorage["lj_juggler_accounts"] = JSON.stringify(new_account_list);

			// We now use a cookie check to see who a use is logged in as.  So clean up the old data.
			localStorage.remove("lastSelected");
		}
	}
	function update_account(change_me)
	{
		var account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
		for(var i = 0; i < account_list.length; i++)
		{
			if(account_list[i].username == change_me.username) account_list[i] = change_me;
		}
		localStorage["lj_juggler_accounts"] = JSON.stringify(account_list);
	}

	</script>
	
	<body onload="page_loaded();">
	</body>
</html>