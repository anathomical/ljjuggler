<html>
	<script type="text/javascript" src="md5.js"></script>
	<script type="text/javascript">
	var ljjuggler_version = "2.0";
	
	function page_loaded()
	{
		if(localStorage["ljjuggler_version"] < ljjuggler_version)
		{
			version_update(localStorage["ljjuggler_version"]);
		}
		console.log("Background page loaded.");
		chrome.extension.onRequest.addListener(
			function(request, sender, sendResponse)
			{
				console.log("Received request...");
				if(request.command == "logout")
				{
					console.log("Logging out...");
					logout(request.account);
				}
				else if(request.command == "login")
				{
					console.log("Logging in as... " + request.account.username);
					loginas(request.account);
				}
				sendResponse({});
				console.log("Request handled, response sent...");
			});
	}
	function getLJchallenge()
	{
		var conn = new XMLHttpRequest();
		var params = "mode=getchallenge";
		conn.open("POST","http://www.livejournal.com/interface/flat",false);
		conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
		conn.send(params);
		challenge = conn.responseText.split("\n")[3];
		return challenge;
	}
	function loginas(this_account)
	{
//		if(localStorage["lastSelected"]) var last_account = JSON.parse(localStorage["lastSelected"]);
		if(chrome.cookies.get({"url":"http://livejournal.com/","name":"ljsession"}, function(cookie) { return cookie; }))
		{
			console.log("Found existing login cookie.");
			logout(last_account);
		}

		console.log("Beginning the login dance...");
		conn = new XMLHttpRequest();
		var challenge = getLJchallenge();
		var response = md5(challenge + this_account.password);
		var params = "mode=sessiongenerate" +
					"&user=" + this_account.username +
					"&auth_method=challenge" +
					"&auth_challenge=" + challenge +
					"&auth_response=" + response;
		conn.open("POST", "http://www.livejournal.com/interface/flat",false);
		conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
		conn.send(params);

		console.log("Login negotiations completed.  Saving session data.");
		var ljsession = conn.responseText.split("\n")[1];
		var now = new Date();
		var cookie_to_set = {};
		cookie_to_set.url = "http://livejournal.com/";
		cookie_to_set.domain = "livejournal.com";
		cookie_to_set.name = "ljsession";
		cookie_to_set.value = ljsession;
		cookie_to_set.expirationDate = now.valueOf()+(1000*60*60*24*365);
		chrome.cookies.set(cookie_to_set);
		localStorage["lastSelected"] = JSON.stringify(this_account);

	}
	function logout(this_account)
	{
		console.log("Logout subroutine started...");
		var challenge = getLJchallenge();
		var response = md5(challenge + this_account.password);
		var session_cookie = chrome.cookies.get({"url":"http://livejournal.com","name":"ljsession"}, function(cookie) { console.log("Do things! " + cookie.value); return cookie; });
		console.log("Found the cookie: " + session_cookie.value);
		var cookie_fields = session_cookie.split(":");
		var sessid = cookie_fields[2].substring(1);
		conn = new XMLHttpRequest()
		var params = "mode=sessionexpire" +
					"&user=" + this_account.username +
					"&auth_method=cookie" +
//					"&auth_challenge=" + challenge +
//					"&auth_response=" + response +
					"&expire_id_" + sessid + "=1";
		conn.open("POST", "http://www.livejournal.com/interface/flat",false);
		conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
		conn.setRequestHeader("X-LJ-Auth","cookie");
		conn.setRequestHeader("Cookie","ljsession=" + session_cookie);
		conn.setRequestHeader("Cookie","ljmastersession=" + session_cookie);
		conn.setRequestHeader("Cookie","ljloggedin=" + cookie_fields[1] + ":" + cookie_fields[2]);
		console.log("Logging out with cookie: " + session_cookie.value);
		conn.send(params);
		console.log("Deleting cookie...");
		chrome.cookies.remove(session_cookie);
	}
	function version_update(old_version)
	{
		alert("LJ Juggler has been updated to the latest version: " + ljjuggler_version + "\n\nCheck out the change log at: http://rushin-doll.net/lj-juggler/change-log.html");
		localStorage["ljjuggler_version"] = ljjuggler_version;
		if(old_version < "2.0")
		{
				// Resave passwords as MD5 hashes for a slight security bump.
			var old_account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			var new_account_list
			for(var account in old_account_list)
			{
				account.password = md5(account.password);
				new_account_list.push(account);
			}
			localStorage["lj_juggler_accounts"] = JSON.stringify(new_account_list);
		}
	}

	</script>
	
	<body onload="page_loaded();">
	</body>
</html>