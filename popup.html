<html>
	<head>
		<style type="text/css">
		body
		{
			background-color:#eeeeee;
			cursor:default;
		}
		div
		{
			padding:2px;
			margin:2px;
			width:120px;
		}
		div.nohover
		{
			background-color:#bbbbff;
			color:#000000;
		}
		div.hover
		{
			background-color:#5555ff;
			color:#ffffff;
		}
		div.selected
		{
			background-color:#33eeff;
			color:#ffffff;
		}
		</style>
		<script type="text/javascript" src="md5.js"></script>
		<script type="text/javascript">
		function page_loaded()
		{
			account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			account_list.sort(accountsort);
			for(var i = 0; account_list[i]; i++)
			{
				var next_option = generate_option(account_list[i]);
				document.getElementById("user_list").appendChild(next_option);
			}
			document.getElementById("option_list").appendChild(build_logout_div());
			chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, highlight_active_account_by_cookie);
		}
		function build_logout_div()
		{
			var this_div = document.createElement("div");
			this_div.id = "livejournal_logout";
			this_div.setAttribute("class","nohover");
			this_div.innerHTML = "Log out";
			this_div.onmouseover = function()
			{
				chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, function(cookie)
					{
						highlight_active_account_by_cookie(cookie);
						this_div.setAttribute("class","hover");
					})
			};
			this_div.onmouseout = function() { this.setAttribute("class","nohover"); };
			this_div.onclick = function()
			{
				chrome.extension.sendRequest({"command":"logout"});
				window.close();
			};
			return this_div;
		}
		function generate_option(this_account)
		{
			var this_div = document.createElement("div");
			this_div.setAttribute("class","nohover");
			this_div.id = this_account.username;
			this_div.innerHTML = this_account.username;
			this_div.onmouseover = function ()
			{
				chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, function(cookie)
					{
						highlight_active_account_by_cookie(cookie);
						this_div.setAttribute("class","hover");
					})
			};
//			this_div.onmouseout = function ()
//			{
//				chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, highlight_active_account_by_cookie);
//			};
			this_div.onclick = function (this_account)
			{ 
				return function ()
				{
					chrome.extension.sendRequest({"command":"login","account":this_account});
					window.close();
				};
			}(this_account);
			return this_div;
		}
		function accountsort(account_one, account_two)
		{
			if(account_one.username == account_two.username) return 0;
			else if(account_one.username < account_two.username) return -1;
			else if(account_one.username > account_two.username) return 1;
		}
		function highlight_active_account_by_cookie(cookie)
		{
			if(cookie)
			{
				var username = get_username_from_uid(cookie.value.split(":")[1]);
				if(username)
				{
					var user_list = document.getElementById("user_list").childNodes;
					for(var i = 0; i < user_list.length; i++)
					{
						if(user_list[i].id == username) user_list[i].setAttribute("class","selected");
						else user_list[i].setAttribute("class","nohover");
					}
				}
			}
		}
		function get_username_from_uid(uid)
		{
			var account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			for(var i = 0; i < account_list.length; i++)
			{
				if(account_list[i].uid == uid)
				{
					return account_list[i].username;
				}
			}
			return 0;
		}
		</script>
	</head>
	<body onload="page_loaded();">
		<div id="user_list" name="user_list"></div>
		<div id="option_list" name="option_list"></div>
	</body>
</html>