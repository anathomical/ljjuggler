<html>
	<head>
		<style type="text/css">
		body
		{
			background-color:#eeeeee;
			cursor:default;
		}
		div
		{
			padding:2px;
			margin:2px;
			width:120px;
		}
		div.nohover
		{
			background-color:#bbbbff;
			color:#000000;
		}
		div.hover
		{
			background-color:#5555ff;
			color:#ffffff;
		}
		div.selected
		{
			background-color:#33eeff;
			color:#ffffff;
		}
		</style>
		<script type="text/javascript" src="md5.js"></script>
		<script type="text/javascript">
		function page_loaded()
		{
			account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			account_list.sort(accountsort);
			if(!localStorage["lastSelected"]) localStorage["lastSelected"] = JSON.stringify({"username":"","password":""});
			for(var i = 0; account_list[i]; i++)
			{
				var next_option = generate_option(account_list[i]);
				document.getElementById("user_list").appendChild(next_option);
			}
			document.getElementById("option_list").appendChild(build_logout_div());
			console.log("test1");
		}
		function build_logout_div()
		{
			var this_div = document.createElement("div");
			this_div.id = "livejournal_logout";
			this_div.setAttribute("class","nohover");
			this_div.innerHTML = "Log out";
			this_div.onmouseover = function() { this.setAttribute("class","hover"); };
			this_div.onmouseout = function() { this.setAttribute("class","nohover"); };
			this_div.onclick = function()
			{
				var last_account = JSON.parse(localStorage["lastSelected"]);
				chrome.extension.sendRequest({"command":"logout","account":last_account});
				document.getElementById(last_account.username).setAttribute("class","nohover");
				localStorage["lastSelected"] = "";
				window.close();
			};
			return this_div;
		}
		
		
		function generate_option(this_account)
		{
			var this_div = document.createElement("div");
			if(this_account.username == JSON.parse(localStorage["lastSelected"]).username) this_div.setAttribute("class","selected");
			else this_div.setAttribute("class","nohover");
			this_div.id = this_account.username;
			this_div.innerHTML = this_account.username;
			this_div.onmouseover = function ()
			{
				this.setAttribute("class","hover");
			};
			this_div.onmouseout = function ()
			{
				if(this_account.username == JSON.parse(localStorage["lastSelected"]).username) this_div.setAttribute("class","selected");
				else this_div.setAttribute("class","nohover");
			};
			this_div.onclick = function (this_account)
			{ 
				return function ()
				{
					if(localStorage["lastSelected"]) var last_account = JSON.parse(localStorage["lastSelected"]);
					console.log("Send login request to background...");
					chrome.extension.sendRequest({"command":"login","account":this_account});
					if(last_account.username) document.getElementById(last_account.username).setAttribute("class","nohover");
					document.getElementById(this_account.username).setAttribute("class","selected");
					console.log("Close popup window...");
					window.close();
				};
			}(this_account);
			return this_div;
		}
		function accountsort(account_one, account_two)
		{
			if(account_one.username == account_two.username) return 0;
			else if(account_one.username < account_two.username) return -1;
			else if(account_one.username > account_two.username) return 1;
		}
		</script>
	</head>
	<body onload="page_loaded();">
		<div id="user_list" name="user_list"></div>
		<div id="option_list" name="option_list"></div>
	</body>
</html>