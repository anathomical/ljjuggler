<html>
	<head>
		<style type="text/css">
		body
		{
			background-color:#fff;
		}
		div
		{
			color: #000;
			font: normal 16px Georgia, "Times New Roman", Times, serif;
			margin: 3px 0px;
			padding: 0px;
			width: 193px;	
			text-shadow: 1px 1px 0px #E1E1E1;
		}
		div#title
		{
			cursor: default;
			font-size: 18px;
			font-variant: small-caps;
			text-align: center;
			text-shadow: none;
		}
		div#user_list .nohover
		{
			background: url(nohover.png) no-repeat;
			color:#000000;
			padding: 4px 4px 8px 40px;
		}
		div#user_list .hover
		{
			background: url(hover.png) no-repeat;
			color:#075a64;
			cursor: pointer;
			padding: 4px 4px 8px 40px;
		}
		div#user_list .select-hover
		{
			background: url(selected.png) no-repeat;
			color:#07511d;
			padding: 4px 4px 8px 40px;
		}
		div#user_list .select-nohover
		{
			background: url(selected.png) no-repeat;
			color: #07511d;
			padding: 4px 4px 8px 40px;
		}
		div#option_list .nohover
		{
			background: url(option_list.png) no-repeat;
			margin: 10px 3px 6px 0px;
			padding: 4px 4px 8px 40px;
		}
		div#option_list .hover
		{
			background: url(option_list_hover.png) no-repeat;
			color: #b30000;
			cursor: pointer;
			margin: 10px 3px 6px 0px;
			padding: 4px 4px 8px 40px;
		}
		div.options
		{
			color: #666;
			cursor: pointer;
			font: normal 12px Arial, Helvetica, sans-serif;
			padding: 6px 0;
			text-align: center;
			text-shadow: none;
		}
		div.options a { color: #b30000; text-decoration: none; }
		div.options a:hover { color: #075a64; text-decoration: underline; }
		
		</style>
		<script type="text/javascript" src="md5.js"></script>
		<script type="text/javascript">
		function page_loaded()
		{
			update_check();
			account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			account_list.sort(accountsort);
			for(var i = 0; account_list[i]; i++)
			{
				var next_option = generate_option(account_list[i]);
				document.getElementById("user_list").appendChild(next_option);
			}
			chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, highlight_active_account_by_cookie);
			console.log("popup.html fully loaded");
		}
		function click_logout_div()
		{
			chrome.extension.sendRequest({"command":"logout"});
			window.close();
		}
		function mouseover_this_div(this_div_id)
		{
			chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, function(cookie)
			{
				highlight_active_account_by_cookie(cookie, this_div_id);
			})
		}
		function mouseout_this_div()
		{
			chrome.cookies.get({"url":"http://www.livejournal.com","name":"ljsession"}, function(cookie)
			{
				highlight_active_account_by_cookie(cookie, 0);
			})
		}
		function click_this_user_div(this_account)
		{
			chrome.extension.sendRequest({"command":"login","account":this_account});
			window.close();
		}
			
		function generate_option(this_account)
		{
			var this_div = document.createElement("div");
			this_div.setAttribute("class","nohover");
			this_div.id = this_account.username;
			this_div.innerHTML = this_account.username;
			this_div.onmouseover = function (this_div)
			{
				return function ()
				{
					mouseover_this_div(this_div.id);
				};
			}(this_div);
			this_div.onmouseout = mouseout_this_div;
			this_div.onclick = function (this_account)
			{ 
				return function ()
				{
					click_this_user_div(this_account);
				};
			}(this_account);
			return this_div;
		}
		function accountsort(account_one, account_two)
		{
			if(account_one.username == account_two.username) return 0;
			else if(account_one.username < account_two.username) return -1;
			else if(account_one.username > account_two.username) return 1;
		}
		function highlight_active_account_by_cookie(cookie, hover_id)
		{
			var logged_username = "";
			if(cookie) logged_username = get_username_from_uid(cookie.value.split(":")[1]);
			console.log("highlighting " + hover_id + " : " + logged_username);
			var user_list = document.getElementById("user_list").childNodes;
			for(var i = 0; i < user_list.length; i++)
			{
				if(user_list[i].id == logged_username)
				{
					if(hover_id == user_list[i].id) user_list[i].setAttribute("class","select-hover");
					else user_list[i].setAttribute("class","select-nohover");
				}
				else if(hover_id == user_list[i].id) user_list[i].setAttribute("class","hover");
				else user_list[i].setAttribute("class","nohover"); 
			}
			var option_list = document.getElementById("option_list").childNodes;
			for(var i = 0; i < option_list.length; i++)
			{
				if(option_list[i].nodeName == "DIV")
				{
					if(hover_id == option_list[i].id) option_list[i].setAttribute("class","hover");
					else option_list[i].setAttribute("class","nohover");
				}
			}

		}
		function get_username_from_uid(uid)
		{
			var account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			for(var i = 0; i < account_list.length; i++)
			{
				if(account_list[i].uid == uid)
				{
					return account_list[i].username;
				}
			}
			return 0;
		}
		function update_check()
		{
			var current_version = getVersion();
			var old_version = "0";
			if(localStorage["ljjuggler_version"]) old_version = localStorage["ljjuggler_version"];
			console.log("checking version - current: " + current_version + " - stored: " + old_version);
			if(old_version != current_version)
			{
				if(!localStorage["version_history_list"] || !find_in_array(JSON.parse(localStorage["version_history_list"]), old_version))
				{
					version_update(old_version, current_version);
				}
			}
			else console.log("up to date");
			localStorage["ljjuggler_version"] = current_version;
		}
		function getVersion()
		{
			var xhr = new XMLHttpRequest();
			xhr.open('GET', chrome.extension.getURL('manifest.json'), false);
			xhr.send(null);
			var manifest = JSON.parse(xhr.responseText);
			return manifest.version;
		}
		function version_update(old_version, current_version)
		{
			console.log("alert user to update");
			alert("LJ Juggler has been updated to the latest version: " + current_version + "\n\nCheck out the change log at: http://rushin-doll.net/lj-juggler/change-log.html");
			console.log("update stored version");
			localStorage["ljjuggler_version"] = current_version;
			var version_history_list = [];
			if(localStorage["version_history_list"]) version_history_list = JSON.parse(localStorage["version_history_list"]);
			console.log("run updates in order");
			if(!find_in_array(version_history_list, "2.0.0"))
			{
				console.log("2.0.0 updates in progress");
					// Resave passwords as MD5 hashes for a slight security bump.
				var old_account_list = [];
				if(localStorage["lj_juggler_accounts"]) old_account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
				console.log("update passwords to hashed versions");
				for(var i = 0; i < old_account_list.length; i++)
				{
					var account = old_account_list[i];
					var old_password = account.passsword;
					account.password = md5(account.password);
					console.log("replacing " + old_password + " with " + account.password);
				}
				console.log("push changes to localStorage");
				localStorage["lj_juggler_accounts"] = JSON.stringify(old_account_list);

				// We now use a cookie check to see who a use is logged in as.  So clean up the old data.
				console.log("removing lastSelected from localStorage");
				localStorage.removeItem("lastSelected");
				
				console.log("push version 2.0.0 into the version_history_list");
				version_history_list.push("2.0.0");
			}
			console.log("updating version_history_list in localStorage");
			localStorage["version_history_list"] = JSON.stringify(version_history_list);
		}
		function find_in_array(array, value)
		{
			for(var i = 0; i < array.length; i++)
			{
				if(value == array[i]) return true;
			}
			return false
		}
		
			</script>
            
            
	</head>
	<body onLoad="page_loaded();">
    	<div id="title">LJ Juggler</div>
		<div id="user_list" name="user_list"></div>
        <div id="option_list" name="option_list">
			<div id="livejournal_logout" class="nohover" onclick="click_logout_div();" onmouseover="mouseover_this_div('livejournal_logout');" onmouseout="mouseout_this_div();">Log out</div>
		</div>
		<div id="links" name="links">
			<div class="options"><a href="#" onclick="chrome.tabs.create({'url': chrome.extension.getURL('options.html')});">Add or Remove Accounts</a></div>
			<div class="options"><a href="#" onclick="chrome.tabs.create({'url': 'http://rushin-doll.net/lj-juggler/'});">About</a> | <a href="#" onclick="chrome.tabs.create({'url': 'http://rushin-doll.net/lj-juggler/change-log.html'});">Changelog</a></div>
		</div>
	</body>
</html>