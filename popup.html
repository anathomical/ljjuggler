<html>
	<head>
		<style type="text/css">
		body
		{
			background-color:#eeeeee;
			cursor:default;
		}
		div
		{
			padding:2px;
			margin:2px;
			width:120px;
		}
		div.nohover
		{
			background-color:#bbbbff;
			color:#000000;
		}
		div.hover
		{
			background-color:#5555ff;
			color:#ffffff;
		}
		div.selected
		{
			background-color:#33eeff;
			color:#ffffff;
		}
		</style>
		<script type="text/javascript" src="md5.js"></script>
		<script type="text/javascript">
		function page_loaded()
		{
			account_list = JSON.parse(localStorage["lj_juggler_accounts"]);
			account_list.sort(accountsort);
			if(!localStorage["lastSelected"]) localStorage["lastSelected"] = JSON.stringify({"username":"","password":""});
			for(var i = 0; account_list[i]; i++)
			{
				var next_option = generate_option(account_list[i]);
				document.getElementById("user_list").appendChild(next_option);
			}
			document.getElementById("option_list").appendChild(build_logout_div());
		}
		function build_logout_div()
		{
			var this_div = document.createElement("div");
			this_div.id = "livejournal_logout";
			this_div.setAttribute("class","nohover");
			this_div.innerHTML = "Log out";
			this_div.onmouseover = function() { this.setAttribute("class","hover"); };
			this_div.onmouseout = function() { this.setAttribute("class","nohover"); };
			this_div.onclick = function()
			{
				var last_account = JSON.parse(localStorage["lastSelected"]);
				logout(last_account);
				document.getElementById(last_account.username).setAttribute("class","nohover");
				localStorage["lastSelected"] = "";
				window.close();
			};
			return this_div;
		}
		
		
		function generate_option(this_account)
		{
			var this_div = document.createElement("div");
			if(this_account.username == JSON.parse(localStorage["lastSelected"]).username) this_div.setAttribute("class","selected");
			else this_div.setAttribute("class","nohover");
			this_div.id = this_account.username;
			this_div.innerHTML = this_account.username;
			this_div.onmouseover = function ()
			{
				this.setAttribute("class","hover");
			};
			this_div.onmouseout = function ()
			{
				if(this_account.username == JSON.parse(localStorage["lastSelected"]).username) this_div.setAttribute("class","selected");
				else this_div.setAttribute("class","nohover");
			};
			this_div.onclick = function (this_account)
			{ 
				return function ()
				{
					loginas(this_account);
				};
			}(this_account);
			return this_div;
		}
		function getLJchallenge()
		{
			var conn = new XMLHttpRequest();
			var params = "mode=getchallenge";
			conn.open("POST","http://www.livejournal.com/interface/flat",false);
			conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
			conn.send(params);
			challenge = conn.responseText.split("\n")[3];
			return challenge;
		}
		function loginas(this_account)
		{
			if(localStorage["lastSelected"]) var last_account = JSON.parse(localStorage["lastSelected"]);
			if(last_account) logout(last_account);
			conn = new XMLHttpRequest();

			
			// This should work.  No idea why it doesn't.
			// Thus we are forced to fall back on the hackery below.
			// For whatever reason, using the interface call to login does not set cookies.
			//var challenge = getLJchallenge();
			//var response = md5(challenge + md5(this_account.password));
			//var params = "mode=login" +
			//			"&user=" + this_account.username +
			//			"&auth_method=challenge" +
			//			"&auth_challenge=" + challenge +
			//			"&auth_response=" + response;
			//conn.open("POST", "http://www.livejournal.com/interface/flat",false);
			//conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
			//conn.send(params);

			// This is much hackier than the above.  But it works.
			var params = "user=" + this_account.username + 
						"&password=" + this_account.password +
						"&remember_me=true";
			conn.open("POST", "https://www.livejournal.com/login.bml", false);
			conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
			conn.send(params);

			localStorage["lastSelected"] = JSON.stringify(this_account);
			if(last_account.username) document.getElementById(last_account.username).setAttribute("class","nohover");
			document.getElementById(this_account.username).setAttribute("class","selected");
			window.close();
		}
		function logout(this_account)
		{
			var challenge = getLJchallenge();
			var response = md5(challenge + md5(this_account.password));
			conn = new XMLHttpRequest()
			var params = "mode=sessionexpire" +
						"&user=" + this_account.username +
						"&auth_method=challenge" +
						"&auth_challenge=" + challenge +
						"&auth_response=" + response +
						"&expireall=1";
					// If I can find some way to parse out the sessid during the
					// hacked together login process I'm using, use expire_id_num
					// instead of expire all so as to not disrupt other machines'
					// login status.
					//	"&expire_id_num=s" + this_account.session;
			conn.open("POST", "http://www.livejournal.com/interface/flat",false);
			conn.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
			conn.send(params);
		}
		function accountsort(account_one, account_two)
		{
			if(account_one.username == account_two.username) return 0;
			else if(account_one.username < account_two.username) return -1;
			else if(account_one.username > account_two.username) return 1;
		}
		</script>
	</head>
	<body onload="page_loaded();">
		<div id="user_list" name="user_list"></div>
		<div id="option_list" name="option_list"></div>
	</body>
</html>